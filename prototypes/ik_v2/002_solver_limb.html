<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title></title></head>
<style>canvas{ display:block; } body, html { padding:0px; margin:0px; width:100%; height:100%; }</style>
<body><script type="module">
// #region IMPORTS
import useThreeWebGL2, { THREE, useDarkScene, useVisualDebug } from '../_lib/useThreeWebGL2.js';
import useTransformMultiControl     from '../_lib/useTransformMultiControl.js';
import Util                         from '../_lib/misc/Util.js';

import facedCube                    from '../_lib/meshes/facedCube.js';

import { 
    Armature, Quat, Vec3, Transform,
} from '../../src/index';

import {
    BoneAxes, IKTarget, IKChain, 
    lookSolver, twoBoneSolver, limbSolver,
} from '../../src/kinematics2/index';
// #endregion

// #region MAIN
let Debug;
let App = useDarkScene( useThreeWebGL2() );
let Ref = {
    gizmo : useTransformMultiControl( App, 2 ).useAxes(),
    tarPos : [0,0.7,0.5],
    polPos : [0,0.7,-1],
};

window.addEventListener( 'load', async _=>{
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup
    App.sphericalLook( 60, 20, 5, [ 0, 0.6, 0 ] );
    Debug = await useVisualDebug( App );
    Ref.gizmo.setPos( 0, Ref.tarPos );
    Ref.gizmo.setPos( 1, Ref.polPos );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Build Skeleton
    const arm = new Armature();
    const b0  = arm.addBone( { name:'b0', pos:[0,0.5,0], parent:undefined } );
    const b1  = arm.addBone( { name:'b1', pos:[0,0.5,0], parent:b0 } );
    const b2  = arm.addBone( { name:'b2', pos:[0,0.5,0], parent:b1 } );

    arm.bind( 0.001 );

    // Util.debugBones( arm.poses.bind.bones, Debug, 0.2, 1, false );
    
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    const pose   = arm.newPose();
    const chain  = new IKChain( arm.bindPose.getBones( ['b0','b1','b2'] ), BoneAxes.UFR );
    const target = new IKTarget();

    target
        .setPositions( Ref.tarPos, Ref.polPos )
        .resolveTarget( chain, pose );

    target.debug( Debug );

    lookSolver( target, chain, pose, Debug );
    twoBoneSolver( target, chain, pose, Debug );

    pose.updateWorld();
    Util.debugBones( pose.bones, Debug, 0.2, 1, false );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    const c1    = facedCube();
    c1.scale.setScalar( 0.2 );

    const c2 = c1.clone();
    const c3 = c1.clone();
    App.scene.add( c1, c2, c3 );

    const sockets = new BoneSockets();
    sockets.attach( 'b0', c1 );
    sockets.attach( 'b1', c2 );
    sockets.attach( 'b2', c3 );
    sockets.updateFromPose( pose );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Ref.chain   = chain;
    Ref.pose    = pose;
    Ref.target  = target;
    Ref.arm     = arm;
    Ref.sockets = sockets;

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    //App.createRenderLoop( onPreRender ).start();
    App.renderLoop();
});

Ref.gizmo.onMove = (i, p)=>{
    Debug.reset();

    // ----------------------
    switch( i ){
        case 0: Ref.tarPos = p; break;
        case 1: Ref.polPos = p; break;
    }

    // ----------------------
    Ref.target.setPositions( Ref.tarPos, Ref.polPos );
    limbSolver( Ref.target, Ref.chain, Ref.pose );

    // Ref.target.debug( Debug );
    
    // ----------------------
    Ref.pose.updateWorld();
    Ref.sockets.updateFromPose( Ref.pose );
    Util.debugBones( Ref.pose.bones, Debug, 0.2, 1, false );
};

function onPreRender( dt, et ){}
// #endregion

// #region SOCKET REDESIGN ???
class Attachment{
    obj     = null;
    offset  = new Transform();
    constructor( obj, off ){
        this.obj = obj;
        if( off ){
            if( off.pos ) this.offset.pos.copy( off.pos );
            if( off.rot ) this.offset.rot.copy( off.rot );
            if( off.scl ) this.offset.scl.copy( off.scl );
        }
    }
}

class BoneSockets{
    items             = new Map();
    transformHandler  = ( o, t )=>{
        o.position.fromArray( t.pos );
        o.quaternion.fromArray( t.rot );
        // o.scale.fromArray( t.scl );
    };

    constructor( tHandler ){
        if( tHandler ) this.transformHandler = tHandler;
    }

    attach( bName, obj, offset=null ){
        let ary = this.items.get( bName );
        if( !ary ){
            ary = [];
            this.items.set( bName, ary );
        }

        ary.push( new Attachment( obj, offset ) );
        return this;
    }

    updateFromPose( pose ){
        for( const [k,v] of this.items ){
            const b = pose.getBone( k );
            for( let i of v ){
                this.transformHandler( i.obj, b.world );
            }
        }
    }
}
// #endregion

</script></body></html>