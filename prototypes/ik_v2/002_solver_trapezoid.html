<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title></title></head>
<style>canvas{ display:block; } body, html { padding:0px; margin:0px; width:100%; height:100%; }</style>
<body><script type="module">
// #region IMPORTS
import useThreeWebGL2, { THREE, useDarkScene, useVisualDebug } from '../_lib/useThreeWebGL2.js';
import useTransformMultiControl from '../_lib/useTransformMultiControl.js';
import Util                     from '../_lib/misc/Util.js';

import facedCube                from '../_lib/meshes/facedCube.js';

import { 
    Armature, Quat, Vec3, Transform,
} from '../../src/index';

import {
    BoneAxes, IKTarget, IKChain, zCompose,
    lookSolver, trapezoidSolver,
} from '../../src/kinematics2/index';
// #endregion

// #region MAIN
let Debug;
let App = useDarkScene( useThreeWebGL2() );
let Ref = {
    gizmo       : useTransformMultiControl( App, 2 ).useAxes(),
    tarPos      : [0,0.7,1],
    polPos      : [0,1.1,-1],
    bCnt        : 4,
    bStep       : 0.7,
    cubes       : [],
};

window.addEventListener( 'load', async _=>{
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup
    App.sphericalLook( 45, 20, 5, [ 0, 0.6, 0 ] );
    Debug = await useVisualDebug( App );

    Ref.gizmo.setPos( 0, Ref.tarPos );
    Ref.gizmo.setPos( 1, Ref.polPos );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Build Skeleton
    // const arm = createTestChain( [ [0,0.4,0], [0,0.3,0], [0,0.6,0], [0,0.3,0] ] );
    const arm = createTestChain( [ [0,0.4,0], [0,1.9630490810141605,0], [0,1.7868094709271223,0], [0,0.7137383919268478,0] ] );
    Util.debugBones( arm.poses.bind.bones, Debug, 0.2, 1, false );

    Ref.arm     = arm;
    Ref.pose    = arm.newPose();
    Ref.cubes   = createBoxChain( Ref.bCnt );

    Ref.chain   = new IKChain( Ref.pose.bones, BoneAxes.UFR );
    Ref.ikt     = new IKTarget();

    poseCubes( Ref.pose );
    runSolver();

    console.log( 'xxx', Ref.ikt.dist );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    //App.createRenderLoop( onPreRender ).start();
    App.renderLoop();
});

// Ref.gizmo.onRotate = (q)=>{ runSolver(); };
Ref.gizmo.onMove = (i, p)=>{
    switch( i ){
        case 0: Ref.tarPos = p; break;
        case 1: Ref.polPos = p; break;
    }

    runSolver();
};

function onPreRender( dt, et ){}
// #endregion

// #region SETUP
function createTestChain( pts ){
    const arm = new Armature();
    let prev  = null;

    for( let i=0; i < pts.length; i++ ){
        prev = arm.addBone( { name:`b${i}`, pos:pts[i], parent:prev } );
    }

    // arm.bind( step );
    arm.bind( 0.001 );
    return arm;
}

function createBoxChain( cnt=3 ){
    const rtn = [];

    for( let i=0; i < cnt; i++ ){
        const c = facedCube();
        c.scale.setScalar( 0.1 );
        rtn.push( c );
        App.scene.add( c );
    }

    return rtn;
}

function poseCubes( pose, offset=[0,0,0] ){
    for( const b of Ref.pose.bones ){
        const c = Ref.cubes[ b.index ];
        c.quaternion.fromArray( b.world.rot );
        c.position.fromArray( b.world.pos );
        c.position.x += offset[0];
        c.position.y += offset[1];
        c.position.z += offset[2];
    }
}
// #endregion

function runSolver(){
    Debug.reset();

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup IK Target
    Ref.ikt.setPositions( Ref.tarPos, Ref.polPos );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Run Solver
    trapezoidCompose( Ref.ikt, Ref.chain, Ref.pose, Debug );
    Ref.pose.updateWorld();

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Visualize Results
    Util.debugBones( Ref.pose.bones, Debug, 0.2, 1, false );
    poseCubes( Ref.pose );
}
// #region 

function trapezoidCompose( target, chain, pose, debug ){
    // Resolve the target to the current pose data
    target.resolveTarget( chain, pose );

    // Align the the root bone to the target direction
    lookSolver( target, chain, pose );

    // // If the target is to far away, straighten the limb
    // // Else bend the mid joint using the idea of triangles
    if( target.dist >= chain.len ) chain.resetPoseLocal( pose, 1 );
    else                           trapezoidSolver( target, chain, pose, debug );
}

</script></body></html>