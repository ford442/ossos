<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title></title></head>
<style>canvas{ display:block; } body, html { padding:0px; margin:0px; width:100%; height:100%; }</style>
<body><script type="module">
// #region IMPORTS
import useThreeWebGL2, { THREE, useDarkScene, useVisualDebug } from '../_lib/useThreeWebGL2.js';
import useTransformControl          from '../_lib/useTransformControl.js';
import Util                         from '../_lib/misc/Util.js';

import facedCube                    from '../_lib/meshes/facedCube.js';

import { 
    Armature,
    Quat, Vec3, Transform,
} from '../../src/index';

import {
    BoneAxes, IKTarget, IKChain, lookSolver
} from '../../src/kinematics2/index';
// #endregion

// #region MAIN
let Debug;
let App = useDarkScene( useThreeWebGL2() );
let Ref = {
    gizmo : useTransformControl( App ).useAxes(),
    tarPos : [0,0.7,2],
};

window.addEventListener( 'load', async _=>{
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup
    App.sphericalLook( 60, 20, 5, [ 0, 0.6, 0 ] );
    Debug = await useVisualDebug( App );
    Ref.gizmo.setPos( Ref.tarPos );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Build Skeleton
    const arm = new Armature();
    const b0  = arm.addBone( { name:'b0', pos:[0,0,0], parent:undefined } );

    b0.local.rot.fromEuler( 45, 0, 0 );
    b0.local.pos.xyz( 0, 0.7, 0.0 );

    arm.bind( 0.2 );

    Util.debugBones( arm.poses.bind.bones, Debug, 0.2, 1, false );
    
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup Object
    Ref.cube = facedCube();
    Ref.cube.rotation.order = 'YXZ';
    Ref.cube.position.fromArray( b0.local.pos );
    Ref.cube.quaternion.fromArray( b0.local.rot );

    Ref.cube.scale.setScalar( 0.5 );
    App.scene.add( Ref.cube );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    const pose   = arm.newPose();
    const chain  = new IKChain( arm.bindPose.getBones( ['b0'] ), BoneAxes.FUR );
    const target = new IKTarget();

    target
        .setPositions( Ref.tarPos )
        .setPoleDir( [0,1,0] )
        .resolveTarget( chain, pose );
    
    // target.debug( Debug );

    lookSolver( target, chain, pose, Debug );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Ref.chain   = chain;
    Ref.pose    = pose;
    Ref.target  = target;
    Ref.arm     = arm;

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    //App.createRenderLoop( onPreRender ).start();
    App.renderLoop();
});

Ref.gizmo.onMove = p=>{
    Debug.reset();

    // ----------------------
    Ref.target
        .setPositions( p )
        .setPoleDir( [0,1,0] )
        .resolveTarget( Ref.chain, Ref.pose );
    // Ref.target.debug( Debug );
    
    // ----------------------
    lookSolver( Ref.target, Ref.chain, Ref.pose, Debug );
    Ref.cube.quaternion.fromArray( Ref.pose.bones[0].local.rot );    
    
    // ----------------------
    Ref.pose.updateWorld();
    Util.debugBones( Ref.pose.bones, Debug, 0.2, 1, false );
};

function onPreRender( dt, et ){}
// #endregion

</script></body></html>