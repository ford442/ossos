<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title></title></head>
<style>canvas{ display:block; } body, html { padding:0px; margin:0px; width:100%; height:100%; }</style>
<body><script type="module">
// #region IMPORTS
import useThreeWebGL2, { THREE, useDarkScene, useVisualDebug } from '../_lib/useThreeWebGL2.js';
import useTransformControl     from '../_lib/useTransformControl.js';
import Util                    from '../_lib/misc/Util.js';

import facedCube               from '../_lib/meshes/facedCube.js';

import { 
    Armature, Quat, Vec3, Transform,
} from '../../src/index';

import {
    BoneAxes, IKTarget, IKChain, 
    lookSolver, twoBoneSolver, limbSolver,
    swingTwistChainSolver,
} from '../../src/kinematics2/index';
// #endregion

// #region MAIN
let Debug;
let App = useDarkScene( useThreeWebGL2() );
let Ref = {
    bCnt        : 5,
    cubes       : [],
    gizmo       : useTransformControl( App ).toRotate(),
    selected    : -1,
    targets     : [
        new THREE.AxesHelper(),
        new THREE.AxesHelper(),
    ],
};

window.addEventListener( 'load', async _=>{
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup
    App.sphericalLook( 0, 20, 5, [ 0, 0.6, 0 ] );
    Debug = await useVisualDebug( App );

    Ref.targets.forEach( (o,i)=>{
        o.scale.setScalar( 0.3 );
        o.position.x = -2;
        o.position.y = 1 * i + 0.1;
        App.scene.add( o );
    });

    Ref.gizmo.attach( Ref.targets[0] );
    Ref.selected = 0;

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Build Skeleton
    const arm = createTestChain( Ref.bCnt, 0.3 );
    Util.debugBones( arm.poses.bind.bones, Debug, 0.2, 1, false );

    Ref.arm     = arm;
    Ref.pose    = arm.newPose();
    Ref.cubes   = createBoxChain( Ref.bCnt );

    Ref.chain   = new IKChain( Ref.pose.bones, BoneAxes.UFR );
    Ref.ikt     = new IKTarget();

    poseCubes( Ref.pose );
    runSolver();

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    //App.createRenderLoop( onPreRender ).start();
    App.renderLoop();
});

// Ref.gizmo.onMove = (p)=>{};
Ref.gizmo.onRotate = (q)=>{ runSolver(); };
function onPreRender( dt, et ){}

window.addEventListener( 'keydown', e=>{
    switch( e.key ){
        case "1": Ref.gizmo.attach( Ref.targets[0] ); Ref.selected = 0; break;
        case "2": Ref.gizmo.attach( Ref.targets[1] ); Ref.selected = 1; break;
        case "3": Ref.gizmo.detach(); Ref.selected = -1; break;
    }
})
// #endregion

// #region SETUP
function createTestChain( cnt=3, step=0.5 ){
    const arm = new Armature();
    let prev  = null;

    for( let i=0; i < cnt; i++ ) prev = arm.addBone( { name:`b${i}`, pos:[0,step,0], parent:prev } );

    arm.bind( step );
    return arm;
}

function createBoxChain( cnt=3 ){
    const rtn = [];

    for( let i=0; i < cnt; i++ ){
        const c = facedCube();
        c.scale.setScalar( 0.2 );
        rtn.push( c );
        App.scene.add( c );
    }

    return rtn;
}

function poseCubes( pose, offset=[2,0,0] ){
    for( const b of Ref.pose.bones ){
        const c = Ref.cubes[ b.index ];
        c.quaternion.fromArray( b.world.rot );
        c.position.fromArray( b.world.pos );
        c.position.x += offset[0];
        c.position.y += offset[1];
        c.position.z += offset[2];
    }
}
// #endregion

function runSolver(){
    Debug.reset();

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Setup IK Target
    const q      = new Quat();
    const swing0 = new Vec3();
    const twist0 = new Vec3();
    const swing1 = new Vec3();
    const twist1 = new Vec3();

    q.copy( Ref.targets[0].quaternion.toArray() );
    swing0.fromQuat( q, Vec3.UP );
    twist0.fromQuat( q, Vec3.FORWARD );

    q.copy( Ref.targets[1].quaternion.toArray() );
    swing1.fromQuat( q, Vec3.UP );
    twist1.fromQuat( q, Vec3.FORWARD );

    Ref.ikt
        .setDirections( swing0, twist0 )
        .setAltDirections( swing1, twist1 );

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Run Solver
    swingTwistChainSolver( Ref.ikt, Ref.chain, Ref.pose, Debug );
    Ref.pose.updateWorld();

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Visualize Results
    Util.debugBones( Ref.pose.bones, Debug, 0.2, 1, false );1
    poseCubes( Ref.pose );
}
// #region 

</script></body></html>